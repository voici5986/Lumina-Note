# Windsurf Cascade 完整架构解析

> **声明**：本文档基于 Cascade（Windsurf AI 助手）的系统配置、工具定义、以及运行时可观察行为整理。这是从 AI 助手视角能看到的设计信息。

---

## 目录

1. [整体架构](#一整体架构)
2. [系统提示词设计](#二系统提示词设计)
3. [思考模式](#三思考模式)
4. [工具系统设计](#四工具系统设计)
5. [子代理架构](#五子代理架构)
6. [记忆系统](#六记忆系统)
7. [任务规划系统](#七任务规划系统)
8. [安全机制](#八安全机制)
9. [工作区感知](#九工作区感知)
10. [与 Claude Skills 对比](#十与-claude-skills-对比)
11. [完整工具定义](#十一完整工具定义)
12. [调试与 Bug 修复](#十二调试与-bug-修复)
13. [长期工作流支持](#十三长期工作流支持)
14. [行为约束汇总](#十四行为约束汇总)

---

## 一、整体架构

### 1.1 Cascade 是什么

Cascade 是 Windsurf IDE 中的 AI 编程助手，设计为**自主代理（Agentic AI）**，而非简单的问答系统。

```
┌─────────────────────────────────────────────────────────────┐
│                    Windsurf IDE                             │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Cascade Agent                        │  │
│  │                                                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │  │
│  │  │ System Prompt│  │    Tools     │  │   Memory    │  │  │
│  │  │  (行为指令)   │  │  (25个工具)  │  │  (持久记忆) │  │  │
│  │  └──────────────┘  └──────────────┘  └─────────────┘  │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────────┐  │  │
│  │  │              Fast Context (子代理)               │  │  │
│  │  │         并行搜索 + 多轮迭代定位代码               │  │  │
│  │  └──────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   用户工作区                          │  │
│  │     文件系统 / 终端 / 浏览器预览 / 部署服务            │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计理念

| 理念 | 说明 |
|------|------|
| **Agentic** | 不只回答问题，能主动执行任务 |
| **Pair Programming** | 作为协作者，而非替代者 |
| **最小侵入** | 不乱创建文件，不打扰用户工作流 |
| **安全优先** | 危险操作必须用户确认 |

### 1.3 信息流架构

```
用户请求
    │
    ↓
┌─────────────────────────────────────────┐
│  Cascade 主代理                         │
│                                         │
│  1. 解析用户意图                         │
│  2. 制定任务计划                         │
│  3. 选择合适工具                         │
│  4. 执行工具调用（可并行）               │
│  5. 处理结果                            │
│  6. 生成回复                            │
└─────────────────────────────────────────┘
    │
    ├──→ code_search (Fast Context 子代理)
    ├──→ grep_search
    ├──→ read_file
    ├──→ edit / multi_edit
    ├──→ run_command
    └──→ ... (其他工具)
    │
    ↓
工具执行结果
    │
    ↓
用户看到的回复
```

### 1.4 完整任务处理流程图

以下是 Cascade 接收到用户请求后的完整处理流程：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户发送请求                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     [思考块 1] 分析用户意图                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - 理解请求内容                                                       │   │
│  │  - 评估任务复杂度                                                     │   │
│  │  - 判断是否 non-trivial                                              │   │
│  │  - 决定是否需要创建计划                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌──────────────┐                ┌──────────────┐
            │ Non-trivial  │                │   Trivial    │
            │  创建计划     │                │  直接执行     │
            └──────┬───────┘                └──────┬───────┘
                   │                               │
                   ▼                               │
    ┌──────────────────────────────┐              │
    │      调用 update_plan        │              │
    │  创建步骤列表，标记第一步     │              │
    │      in_progress            │              │
    └──────────────┬───────────────┘              │
                   │                               │
                   └───────────────┬───────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          需要获取信息？                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         ▼                         ▼                         ▼
┌─────────────────┐     ┌─────────────────┐      ┌─────────────────┐
│  需要探索代码库  │     │  知道具体位置   │      │   需要网络信息   │
└────────┬────────┘     └────────┬────────┘      └────────┬────────┘
         │                       │                        │
         ▼                       ▼                        ▼
┌─────────────────┐     ┌─────────────────┐      ┌─────────────────┐
│   code_search   │     │   read_file     │      │   search_web    │
│ (Fast Context)  │     │   grep_search   │      │ read_url_content│
│                 │     │   find_by_name  │      │                 │
│  ┌───────────┐  │     │   list_dir      │      │                 │
│  │ 子代理执行 │  │     │                 │      │                 │
│  │ 并行grep  │  │     │                 │      │                 │
│  │ 并行read  │  │     │                 │      │                 │
│  │ 多轮迭代  │  │     │                 │      │                 │
│  └───────────┘  │     │                 │      │                 │
└────────┬────────┘     └────────┬────────┘      └────────┬────────┘
         │                       │                        │
         └───────────────────────┴────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     [思考块 2] 分析工具返回结果                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - 理解返回的信息                                                     │   │
│  │  - 判断信息是否充足                                                   │   │
│  │  - 决定下一步行动                                                     │   │
│  │  - 如需更多信息，继续调用工具                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           需要修改代码？                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         ▼                       ▼                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    单处修改     │     │    多处修改     │     │    创建新文件    │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│      edit       │     │   multi_edit    │     │  write_to_file  │
│                 │     │                 │     │                 │
│  old_string →   │     │  多个编辑操作   │     │  创建文件+父目录 │
│  new_string     │     │  原子执行       │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         └───────────────────────┴───────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           需要执行命令？                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                    ┌────────────┴────────────┐
                    ▼                         ▼
          ┌─────────────────┐       ┌─────────────────┐
          │    安全命令     │       │   不安全命令    │
          │ SafeToAutoRun   │       │  需要用户确认   │
          │    = true       │       │                 │
          └────────┬────────┘       └────────┬────────┘
                   │                         │
                   ▼                         ▼
          ┌─────────────────┐       ┌─────────────────┐
          │   自动执行      │       │   等待用户确认   │
          │   run_command   │       │   run_command   │
          └────────┬────────┘       └────────┬────────┘
                   │                         │
                   └────────────┬────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     [思考块 N] 评估执行结果                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  - 命令是否成功执行                                                   │   │
│  │  - 是否需要更多操作                                                   │   │
│  │  - 任务是否完成                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            任务完成？                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
               ┌────────────────┴────────────────┐
               ▼                                 ▼
       ┌──────────────┐                  ┌──────────────┐
       │     否       │                  │      是      │
       │  继续执行    │                  │   完成任务   │
       └──────┬───────┘                  └──────┬───────┘
              │                                 │
              ▼                                 ▼
   ┌────────────────────┐           ┌────────────────────┐
   │ 如有计划，更新状态  │           │ 如有计划，标记完成  │
   │   update_plan      │           │   update_plan      │
   │ 下一步 in_progress │           │ 全部 completed     │
   └─────────┬──────────┘           └─────────┬──────────┘
             │                                │
             │                                ▼
             │               ┌────────────────────────────────────┐
             │               │         生成最终回复               │
             │               │  - 清晰的任务完成状态总结           │
             │               │  - 关键修改说明                    │
             │               │  - 后续建议（如适用）              │
             │               └────────────────────────────────────┘
             │                                │
             │                                ▼
             │               ┌────────────────────────────────────┐
             │               │          用户看到回复              │
             │               └────────────────────────────────────┘
             │
             └──────────────────────────────┐
                                            │
                                            ▼
                              ┌─────────────────────────┐
                              │  返回到"需要获取信息？" │
                              │      继续下一轮         │
                              └─────────────────────────┘
```

### 1.5 工具调用决策树

```
用户请求
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                      需要什么操作？                          │
└─────────────────────────────────────────────────────────────┘
    │
    ├─── 探索代码库 ──────────────────────────────────────────┐
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 不知道代码位置？                                  │  │
    │    │     └→ code_search (Fast Context)               │  │
    │    │        - 自然语言查询                            │  │
    │    │        - 并行搜索 + 多轮迭代                     │  │
    │    │                                                  │  │
    │    │ 知道关键词？                                      │  │
    │    │     └→ grep_search                              │  │
    │    │        - 精确匹配或正则                          │  │
    │    │        - 支持文件过滤                            │  │
    │    │                                                  │  │
    │    │ 知道文件名模式？                                  │  │
    │    │     └→ find_by_name                             │  │
    │    │        - glob 模式匹配                           │  │
    │    │        - 扩展名过滤                              │  │
    │    │                                                  │  │
    │    │ 浏览目录结构？                                    │  │
    │    │     └→ list_dir                                 │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    ├─── 读取文件 ────────────────────────────────────────────┤
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 普通文件？                                        │  │
    │    │     └→ read_file                                │  │
    │    │        - 支持 offset/limit 分页                  │  │
    │    │        - 支持图片显示                            │  │
    │    │                                                  │  │
    │    │ Jupyter Notebook？                               │  │
    │    │     └→ read_notebook                            │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    ├─── 修改代码 ────────────────────────────────────────────┤
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 单处修改？                                        │  │
    │    │     └→ edit                                     │  │
    │    │        - old_string 必须唯一                     │  │
    │    │                                                  │  │
    │    │ 多处修改？                                        │  │
    │    │     └→ multi_edit                               │  │
    │    │        - 原子操作，全部成功或全部失败             │  │
    │    │                                                  │  │
    │    │ 创建新文件？                                      │  │
    │    │     └→ write_to_file                            │  │
    │    │        - 自动创建父目录                          │  │
    │    │                                                  │  │
    │    │ 编辑 Notebook？                                  │  │
    │    │     └→ edit_notebook                            │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    ├─── 执行命令 ────────────────────────────────────────────┤
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 运行命令？                                        │  │
    │    │     └→ run_command                              │  │
    │    │        - 使用 Cwd 而非 cd                        │  │
    │    │        - SafeToAutoRun 判断安全性               │  │
    │    │                                                  │  │
    │    │ 检查后台命令？                                    │  │
    │    │     └→ command_status                           │  │
    │    │                                                  │  │
    │    │ 读取终端输出？                                    │  │
    │    │     └→ read_terminal                            │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    ├─── Web 预览/部署 ───────────────────────────────────────┤
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 预览 Web 服务？                                   │  │
    │    │     └→ browser_preview                          │  │
    │    │                                                  │  │
    │    │ 部署应用？                                        │  │
    │    │     └→ read_deployment_config → deploy_web_app  │  │
    │    │                                                  │  │
    │    │ 检查部署状态？                                    │  │
    │    │     └→ check_deploy_status                      │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    ├─── 网络搜索 ────────────────────────────────────────────┤
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 搜索网页？                                        │  │
    │    │     └→ search_web                               │  │
    │    │                                                  │  │
    │    │ 读取 URL？                                        │  │
    │    │     └→ read_url_content                         │  │
    │    │                                                  │  │
    │    │ 查看文档分块？                                    │  │
    │    │     └→ view_content_chunk                       │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    ├─── 记忆/规划 ───────────────────────────────────────────┤
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 保存记忆？                                        │  │
    │    │     └→ create_memory                            │  │
    │    │                                                  │  │
    │    │ 管理任务计划？                                    │  │
    │    │     └→ update_plan                              │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    ├─── 历史对话 ────────────────────────────────────────────┤
    │                                                         │
    │    ┌─────────────────────────────────────────────────┐  │
    │    │ 搜索历史对话？                                    │  │
    │    │     └→ trajectory_search                        │  │
    │    └─────────────────────────────────────────────────┘  │
    │                                                         │
    └─── MCP 资源 ────────────────────────────────────────────┘
                                                              
         ┌─────────────────────────────────────────────────┐  
         │ 列出 MCP 资源？                                   │  
         │     └→ list_resources                           │  
         │                                                  │  
         │ 读取 MCP 资源？                                   │  
         │     └→ read_resource                            │  
         └─────────────────────────────────────────────────┘  
```

### 1.6 并行 vs 顺序调用规则

```
┌─────────────────────────────────────────────────────────────┐
│                      并行调用规则                            │
└─────────────────────────────────────────────────────────────┘

✅ 可以并行（独立操作）：
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   read_file(a.go) ──┬── 并行执行                            │
│   read_file(b.go) ──┤                                       │
│   grep_search(...)──┘                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘

❌ 必须顺序（依赖操作）：
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   read_file(a.go)                                          │
│         │                                                   │
│         ▼                                                   │
│   edit(a.go, ...)  ← 必须等读取完成                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘

❌ 必须顺序（破坏性操作）：
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   run_command("rm -rf temp")                               │
│         │                                                   │
│         ▼                                                   │
│   run_command("mkdir temp")  ← 必须等删除完成               │
│                                                             │
└─────────────────────────────────────────────────────────────┘

⚠️ 特殊限制：
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   code_search ← 不能与其他工具并行调用                       │
│   "IMPORTANT: YOU CANNOT CALL THIS TOOL IN PARALLEL."      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、系统提示词设计

### 2.1 系统提示词结构

Windsurf 的 System Prompt 由多个模块组成：

```
┌─────────────────────────────────────────┐
│           System Prompt                 │
│                                         │
│  ├── 身份定义                           │
│  ├── 通信风格 (communication_style)     │
│  │   ├── markdown_formatting            │
│  │   └── additional_guidelines          │
│  ├── 工具调用规则 (tool_calling)        │
│  ├── 代码修改规则 (making_code_changes) │
│  ├── 命令执行规则 (running_commands)    │
│  ├── 调试原则 (debugging)               │
│  ├── API 调用规则 (calling_external_apis)│
│  ├── 记忆系统 (memory_system)           │
│  ├── 任务管理 (task_management)         │
│  ├── 用户信息 (user_information)        │
│  └── 工作区信息 (workspace_information) │
└─────────────────────────────────────────┘
```

### 2.2 身份定义

```
You are Cascade, a powerful agentic AI coding assistant.
The USER is interacting with you through a chat panel in their IDE.
You will send requests to solve a coding task by pair programming with you.
Be mindful that you are not the only one working in this computing environment.
Do not overstep your bounds, your goal is to be a pair programmer.
```

### 2.3 通信风格规则

**Markdown 格式规范**：
- 单反引号用于变量/函数名：`variableName`
- 代码块标注语言：```go
- 正确使用标题层级：# ## ###
- 列表项标题加粗：**标题**
- 不用 unicode 符号，用 markdown 语法

**代码引用格式**：
```markdown
单行引用：
```@/absolute/path/to/file.go#42
existingCode()
```

多行引用：
```@/absolute/path/to/file.go#10:15
line10
line11
...
```
```

**额外准则**：
- 简洁直接，避免冗长
- 不以 "Great idea!" 等承认短语开头
- 直接回应，不先验证用户请求
- 推断意图并执行，而非只建议
- 以清晰的任务总结结束对话

### 2.4 工具调用规则

```
核心原则：
- 只使用可用工具，不猜测参数
- 调用前简要说明原因
- 独立操作并行执行
- 依赖操作顺序执行
- 破坏性操作始终顺序

搜索优先级：
1. code_search (Fast Context) ← 首选，用于开始搜索
2. grep_search                 ← 精确匹配/正则搜索
3. find_by_name                ← 按文件名搜索
4. list_dir                    ← 浏览目录结构
```

### 2.5 代码修改规则

```
核心要求：
- 偏好最小、聚焦的编辑
- 编辑前必须先读取文件
- 保持现有代码风格
- 生成的代码必须立即可运行
- 添加所有必要的 import、依赖
- 大编辑(>300行)分成多个小编辑
- import 必须在文件顶部

新项目创建时：
- 创建依赖管理文件和 README
- Web 应用使用现代 UI：React, Lucide, TailwindCSS, shadcn/ui
```

### 2.6 命令执行安全规则

```
关键规则：
- 永远不要在命令中包含 cd，使用 cwd 参数
- 检查现有服务再启动新的
- 小心写操作

安全判断：
- 安全命令（可自动执行）：ls, cat, pwd, go build, go test
- 不安全命令（需确认）：rm, del, 安装依赖, 外部请求

即使用户要求，也不能自动运行不安全命令
```

---

## 三、思考模式

### 3.1 Extended Thinking（扩展思考）

Cascade 使用 Claude 的 **Extended Thinking** 特性，可以在回复前进行深度推理。

#### 思考模型 vs 非思考模型

```
┌─────────────────────────────────────────────────────────────┐
│                    思考模型（Extended Thinking）             │
│                                                             │
│  用户请求                                                    │
│      │                                                      │
│      ↓                                                      │
│  ┌─────────────────────────────────┐                        │
│  │  <thinking> 内部推理过程 </thinking>  │  ← Windsurf 渲染为 │
│  │  分析任务、规划步骤、验证逻辑...     │    "Thought for Xs" │
│  └─────────────────────────────────┘                        │
│      │                                                      │
│      ↓                                                      │
│  ┌─────────────────────────────────┐                        │
│  │  正常输出内容                    │  ← 展示给用户的最终回复 │
│  └─────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    非思考模型                                │
│                                                             │
│  用户请求                                                    │
│      │                                                      │
│      ↓                                                      │
│  ┌─────────────────────────────────┐                        │
│  │  直接输出最终回复                │  ← 没有可见的推理过程   │
│  └─────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

#### 关键区别

| 方面 | 思考模型 | 非思考模型 |
|------|---------|-----------|
| **思考可见性** | 可折叠展示 | 无 |
| **推理透明度** | 高（可查看思考过程） | 低（黑盒） |
| **输出延迟** | 略长（需先思考） | 较快 |
| **复杂任务表现** | 更好（深度推理） | 一般 |

### 3.2 Interleaved Thinking（交错思考）

Cascade 配置为 **交错思考模式**，允许思考和输出交替进行：

```xml
<thinking_mode>interleaved</thinking_mode>
```

#### 三种思考模式

| 模式 | 行为 |
|------|------|
| **none** | 无思考块，直接输出 |
| **single** | 开头思考一次，然后全部输出 |
| **interleaved** | 思考和输出可以交错进行 |

#### 交错模式工作流程

```
用户请求
    │
    ↓
[思考块1] → 分析任务，决定读取文件
    │
    ↓
[输出] → 调用 read_file 工具
    │
    ↓
← 工具返回结果 ←
    │
    ↓
[思考块2] → 分析文件内容，发现问题
    │
    ↓
[输出] → 调用 edit 工具修复
    │
    ↓
← 工具返回结果 ←
    │
    ↓
[思考块3] → 确认修复完成
    │
    ↓
[输出] → 最终回复给用户
```

#### 系统指导

系统提示词中明确指导：
> *"If the thinking_mode is interleaved or auto, then after function results you should strongly consider outputting a thinking block."*

这使得模型能够根据每次工具调用的结果进行即时推理和调整策略。

### 3.3 思考模式对用户体验的影响

```
交错思考模式的优势：
- 可以根据中间结果动态调整策略
- 每次工具调用后都能深入分析
- 更好地处理复杂、多步骤任务
- 用户可以看到推理过程，增加透明度

单次思考模式的局限：
- 只能在开始时规划一次
- 无法根据执行结果调整
- 遇到意外情况难以应对
```

---

## 四、工具系统设计

### 4.1 工具架构

Windsurf 采用**统一工具池**设计，所有 25 个工具通过 Function Call 定义传递给模型：

```
┌─────────────────────────────────────────────────────────────┐
│                    Tool Definitions                         │
│                   (JSON Schema 格式)                        │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ code_search │  │ grep_search │  │ find_by_name│  ...    │
│  │             │  │             │  │             │         │
│  │ name        │  │ name        │  │ name        │         │
│  │ description │  │ description │  │ description │         │
│  │ parameters  │  │ parameters  │  │ parameters  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
                   模型选择调用哪个工具
                            │
                            ↓
                   Windsurf 后端执行
```

### 4.2 工具分类

| 类别 | 工具数 | 工具列表 |
|------|--------|----------|
| 代码搜索 | 4 | code_search, grep_search, find_by_name, list_dir |
| 文件读写 | 4 | read_file, edit, multi_edit, write_to_file |
| 终端命令 | 3 | run_command, command_status, read_terminal |
| Web 部署 | 4 | browser_preview, deploy_web_app, read_deployment_config, check_deploy_status |
| 记忆规划 | 2 | create_memory, update_plan |
| 网络搜索 | 3 | search_web, read_url_content, view_content_chunk |
| 历史对话 | 1 | trajectory_search |
| Notebook | 2 | read_notebook, edit_notebook |
| MCP | 2 | list_resources, read_resource |
| **总计** | **25** | |

### 4.3 工具调用并行策略

```python
# Windsurf 的并行调用规则

# ✅ 可以并行：独立操作
parallel_calls = [
    read_file("file_a.go"),
    read_file("file_b.go"),
    grep_search("pattern", "dir_c"),
]

# ❌ 必须顺序：依赖操作
sequential_calls = [
    read_file("file.go"),      # 先读
    edit("file.go", ...),      # 再改
]

# ❌ 必须顺序：破坏性操作
sequential_calls = [
    run_command("rm -rf temp"),
    run_command("mkdir temp"),
]

# ⚠️ 特殊限制：code_search 不能并行调用
# "IMPORTANT: YOU CANNOT CALL THIS TOOL IN PARALLEL."
```

---

## 五、子代理架构

### 5.1 子代理总览

Cascade 采用**主代理 + 子代理**的架构设计：

```
┌─────────────────────────────────────────────────────────────┐
│                    Cascade 主代理                            │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │             子代理 (Subagent)                        │   │
│  │                                                      │   │
│  │  code_search (Fast Context)  ← 唯一的子代理          │   │
│  │  - 并行 grep + readfile                             │   │
│  │  - 多轮迭代搜索                                      │   │
│  │  - 有自己的推理能力                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │             直接工具 (24个)                           │   │
│  │                                                      │   │
│  │  grep_search, find_by_name, list_dir                │   │
│  │  read_file, edit, multi_edit, write_to_file         │   │
│  │  run_command, command_status, read_terminal         │   │
│  │  browser_preview, deploy_web_app, ...               │   │
│  │  create_memory, update_plan, ...                    │   │
│  │  search_web, read_url_content, ...                  │   │
│  │                                                      │   │
│  │  → 全部由主代理直接调用，无中间代理                   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**关键点**：
- 只有 `code_search` 工具明确标注为 **subagent**（子代理）
- 其他 24 个工具都是主代理直接调用的原子操作
- 任务规划（`update_plan`）由主代理自己判断和执行，无子代理参与

### 5.2 Fast Context 子代理

#### 什么是 Fast Context

Fast Context 是 Windsurf 内置的**搜索子代理**，通过 `code_search` 工具调用。

官方描述：
> "A search subagent the user refers to as 'Fast Context' that is ideal for exploring the codebase based on a request. This tool invokes a subagent that runs **parallel grep and readfile calls over multiple turns** to locate line ranges and files which might be relevant to the request."

#### 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                Fast Context (Subagent)                      │
│                                                             │
│  输入: 自然语言查询                                          │
│  "Find where authentication requests are handled"           │
│                                                             │
│  ┌────────────────── 第 1 轮 ──────────────────┐            │
│  │                                             │            │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐     │            │
│  │  │  grep   │  │  grep   │  │  grep   │     │  并行执行   │
│  │  │ "auth"  │  │ "login" │  │ "token" │     │            │
│  │  └────┬────┘  └────┬────┘  └────┬────┘     │            │
│  │       └──────────┬─────────────┘           │            │
│  │                  ↓                         │            │
│  │       发现: auth.go, middleware/auth.go    │            │
│  └─────────────────────────────────────────────┘            │
│                         ↓                                   │
│  ┌────────────────── 第 2 轮 ──────────────────┐            │
│  │                                             │            │
│  │  ┌──────────┐  ┌──────────┐                │            │
│  │  │ readfile │  │ readfile │                │  并行执行   │
│  │  │ auth.go  │  │ m/auth.go│                │            │
│  │  └────┬─────┘  └────┬─────┘                │            │
│  │       └──────┬──────┘                      │            │
│  │              ↓                             │            │
│  │       理解上下文，定位具体函数               │            │
│  └─────────────────────────────────────────────┘            │
│                         ↓                                   │
│  ┌────────────────── 第 N 轮 ──────────────────┐            │
│  │                                             │            │
│  │       根据前几轮结果，继续深入搜索            │            │
│  │       直到找到足够相关的代码片段              │            │
│  └─────────────────────────────────────────────┘            │
│                         ↓                                   │
│  输出: 相关文件 + 行范围 + 代码片段                          │
└─────────────────────────────────────────────────────────────┘
```

#### 核心特点

| 特点 | 说明 |
|------|------|
| **并行搜索** | 同时执行多个 grep 查找不同关键词 |
| **并行读取** | 同时读取多个相关文件 |
| **多轮迭代** | 每轮结果作为下一轮的输入，逐步细化 |
| **自然语言** | 查询是目标导向的自然语言，不是关键词 |
| **独立子代理** | 有自己的推理能力，能理解查询意图 |

#### 调用时机

```
主代理判断流程：

用户请求
    │
    ↓
是否知道代码具体位置？
    │
    ├── 是（用户给了路径）→ 直接 read_file
    │
    └── 否（需要探索）→ 调用 code_search (Fast Context)
                              │
                              ↓
                        子代理并行搜索
                              │
                              ↓
                        多轮迭代定位
                              │
                              ↓
                        返回结果给主代理
                              │
                              ↓
                        主代理评估结果完整性
                              │
                              ├── 完整 → 继续任务
                              │
                              └── 不完整 → grep_search 补充
```

#### 查询设计最佳实践

```
✅ 好的查询（目标导向）：
- "Find where authentication requests are handled in the Express routes"
- "Modify the agentic rollout to use the new tokenizer and chat template"
- "Fix the bug where the user gets redirected from the /feed page"

❌ 差的查询（太宽泛）：
- "search files"
- "find code"
- "authentication"
```

#### 子代理模型

关于 Fast Context 使用什么模型，官方没有明确说明。可能的情况：

| 可能性 | 说明 |
|--------|------|
| 使用相同模型 | 复用用户选择的模型（如 Claude） |
| 使用轻量模型 | 为了速度，用小模型做搜索决策 |
| 混合策略 | 搜索用小模型，汇总用大模型 |

**推测**：从实现简单性角度，可能复用用户选择的模型。

---

## 六、记忆系统

### 6.1 记忆类型

```
┌─────────────────────────────────────────────────────────────┐
│                    Memory System                            │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  1. Global Rules (全局规则)                          │   │
│  │     始终遵循的系统级规则                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  2. User-provided Memories (用户记忆)               │   │
│  │     用户显式提供的上下文                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  3. System-retrieved Memories (系统检索记忆)         │   │
│  │     从历史对话自动检索的可能相关记忆                   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 记忆操作

通过 `create_memory` 工具管理：

```json
{
  "name": "create_memory",
  "parameters": {
    "Action": "create | update | delete",
    "Id": "string (更新/删除时使用)",
    "Title": "string (记忆标题)",
    "Content": "string (记忆内容)",
    "Tags": ["string"] (标签，snake_case),
    "CorpusNames": ["string"] (关联的工作区),
    "UserTriggered": "boolean (是否用户主动要求)"
  }
}
```

### 6.3 记忆使用原则

```
- 记忆可能过时或错误，使用前验证相关性
- 与当前任务无关的记忆应忽略
- 创建新记忆前，检查是否已存在语义相关的记忆
- 如果存在，更新而非创建重复
```

### 6.4 适合保存的记忆内容

- 用户偏好
- 项目结构
- 重要代码片段
- 技术栈信息
- 架构决策
- 里程碑和功能
- 设计模式

---

## 七、任务规划系统

### 7.1 规划工具

通过 `update_plan` 工具管理任务计划：

```json
{
  "name": "update_plan",
  "parameters": {
    "explanation": "string",
    "plan": [
      {
        "step": "string (步骤描述)",
        "status": "pending | in_progress | completed"
      }
    ]
  }
}
```

### 7.2 触发时机

**关键判断：任务是否"非平凡"（non-trivial）**

```
用户请求
    │
    ↓
这是一个简单问答吗？
    │
    ├── 是 → 直接回答，不创建 Plan
    │
    └── 否 → 需要执行多个步骤吗？
              │
              ├── 否（1-2步）→ 可能不创建 Plan，直接做
              │
              └── 是（3步以上）→ 创建 Plan
```

**触发 vs 不触发对照表**：

| 任务类型 | 是否显示 Plan | 示例 |
|----------|--------------|------|
| 简单问答 | ❌ 不显示 | "这行代码什么意思" |
| 单步任务 | ❌ 不显示 | "读一下这个文件" |
| 多步骤任务 | ✅ 显示 | "帮我重构这个模块" |
| 复杂任务 | ✅ 显示 | "添加用户认证功能" |
| 涉及多文件 | ✅ 显示 | "修复登录 bug" |
| 需要搜索+修改+验证 | ✅ 显示 | "找到并修复问题" |

**会创建 Plan 的请求示例**：
- "帮我给这个项目添加用户认证功能"
- "重构这个模块，拆分成多个文件"
- "找到并修复登录页面的 bug"
- "搭建一个新的 React 项目"

**不会创建 Plan 的请求示例**：
- "解释一下这段代码"
- "帮我搜索一下 auth 相关的文件"
- "把这个变量名改一下"

### 7.3 Non-trivial 判断标准

系统提示词没有给出量化定义，由 Cascade **自主判断**。以下是判断标准：

#### 判断维度

| 维度 | Trivial (不创建计划) | Non-trivial (创建计划) |
|------|---------------------|----------------------|
| **步骤数** | 1-2 步 | 3+ 步 |
| **文件数** | 单文件 | 多文件 |
| **操作类型** | 单一操作 | 搜索+分析+修改 组合 |
| **需要验证** | 否 | 是 |
| **上下文探索** | 不需要 | 需要理解代码结构 |

#### 判断流程

```
收到用户请求
    │
    ↓
预估需要几步完成？
    │
    ├─ ≤2 步 → Trivial，直接执行
    │
    └─ ≥3 步 → 继续判断
                │
                ↓
          是否涉及多文件或需要验证？
                │
                ├─ 否 → 可能还是 Trivial
                │
                └─ 是 → Non-trivial，创建计划
```

#### 动态升级

有时候初看 trivial，执行中发现变复杂：

```
用户："改一下这个函数"
    │
    ↓
[开始执行，未创建计划]
    │
    ↓
发现需要改多个相关文件
    │
    ↓
[中途创建计划] ← 动态升级为 non-trivial
```

**重要**：没有硬性标准，是基于任务复杂度的启发式判断，由主代理自己决定，无子代理参与。

### 7.4 规划原则

```
1. 非平凡任务制定简洁计划
2. 同一时间只有一个步骤 in_progress
3. 完成后立即标记为 completed
4. 发现新约束时更新计划
5. 只在真正需要时创建共享笔记
```

### 7.5 规划节奏

```
任务开始
    │
    ↓
理解用户请求
    │
    ↓
制定简洁计划（如果非平凡）
    │
    ↓
┌─────────────────────────┐
│  执行步骤（一次一个）    │ ←─┐
│  - 标记 in_progress     │    │
│  - 执行                 │    │
│  - 标记 completed       │    │
└─────────────────────────┘    │
    │                          │
    ↓                          │
还有步骤？────────────────────┘
    │
    ↓ (完成)
清晰的状态总结
```

---

## 八、安全机制

### 8.1 命令安全分类

```
┌─────────────────────────────────────────────────────────────┐
│                    安全命令（可自动执行）                    │
│                                                             │
│  - ls, cat, pwd, echo                                       │
│  - go build, go test, go run                                │
│  - npm run dev, npm test                                    │
│  - git status, git log, git diff                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                 不安全命令（需用户确认）                     │
│                                                             │
│  - rm, del, rmdir (删除文件)                                │
│  - mv (移动/重命名)                                         │
│  - npm install, pip install (安装依赖)                      │
│  - curl, wget (外部请求)                                    │
│  - git push, git commit (代码变更)                          │
│  - chmod, chown (权限变更)                                  │
│  - 任何可能有破坏性副作用的命令                              │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 安全原则

```
1. 即使用户要求，也不能自动运行不安全命令
2. 用户可以通过设置中的允许列表自定义
3. 在不确定时，默认需要确认
4. 不在响应中提及具体的安全参数名称
```

### 8.3 编辑安全

```
1. 编辑前必须读取文件
2. 不猜测文件内容
3. 保持原有缩进和风格
4. old_string 必须在文件中唯一匹配
5. 不创建不必要的文件
```

---

## 九、工作区感知

### 9.1 用户信息

系统提示词中包含：
```
- 用户操作系统版本
- 活跃工作区列表（URI 和 CorpusName 映射）
```

### 9.2 工作区文件结构快照

```
对话开始时提供工作区文件结构快照：
- 目录树
- 文件列表
- 跳过 .gitignore 的文件

注意：快照不会在对话中更新，可能过时
```

### 9.3 IDE 元数据

```
可能包含：
- 当前打开的文档
- 光标位置
- 其他打开的文档

原则：
- 元数据可能与用户请求无关
- 先考虑用户实际请求
- 只在明显相关时使用 IDE 元数据
```

---

## 十、与 Claude Skills 对比

### 10.1 架构对比

| 特性 | Windsurf | Claude Skills |
|------|----------|---------------|
| **工具定义** | Function Call (JSON Schema) | SKILL.md (Markdown) |
| **加载策略** | 所有工具一次性加载 | 渐进式按需加载 |
| **Token 效率** | 工具多时消耗大 | 只加载相关内容 |
| **扩展方式** | 修改代码添加工具 | 添加文件夹即可 |
| **用户自定义** | 不支持 | 支持 |
| **脚本执行** | run_command 工具 | 内嵌脚本 + bash |

### 10.2 Claude Skills 的渐进式披露

```
第1层：只加载 name + description 到 System Prompt
       ↓
用户任务触发相关 Skill
       ↓
第2层：读取完整 SKILL.md 内容
       ↓
按需深入
       ↓
第3层：读取 forms.md, reference.md 等子文件
```

### 10.3 Claude Programmatic Tool Calling

Claude 还支持让模型自己写 Python 代码在沙箱中执行：

```
传统方式：Claude 逐个请求工具，所有中间结果进入上下文
PTC 方式：Claude 写 Python 编排多个工具调用，只有最终结果进入上下文

优势：
- Token 节省 37%
- 减少推理次数
- 代码逻辑比自然语言更精确
```

### 10.4 Windsurf 的设计权衡

```
Windsurf 选择：
- 统一工具池 + System Prompt 引导
- Fast Context 子代理封装复杂搜索
- 不支持用户自定义 Skills

原因推测：
- 实现简单
- IDE 环境可控
- 聚焦编程场景
```

---

## 十一、完整工具定义

### 11.1 代码搜索类

#### code_search (Fast Context)
```json
{
  "name": "code_search",
  "description": "搜索子代理，用于探索代码库。并行执行 grep 和 readfile，多轮迭代定位。",
  "parameters": {
    "search_term": "string - 目标导向的自然语言查询",
    "search_folder_absolute_uri": "string - 搜索的绝对路径"
  },
  "notes": "不能并行调用此工具"
}
```

#### grep_search
```json
{
  "name": "grep_search",
  "description": "基于 ripgrep 的文本搜索",
  "parameters": {
    "Query": "string - 搜索词或正则表达式",
    "SearchPath": "string - 搜索路径（必填）",
    "IsRegex": "boolean - 是否正则模式",
    "CaseSensitive": "boolean - 区分大小写",
    "Includes": "string[] - glob 过滤，如 '*.go'",
    "MatchPerLine": "boolean - 显示匹配行上下文"
  },
  "notes": "不要用 bash 执行 grep/rg，用这个工具"
}
```

#### find_by_name
```json
{
  "name": "find_by_name",
  "description": "基于 fd 的文件名搜索",
  "parameters": {
    "SearchDirectory": "string - 搜索目录",
    "Pattern": "string - glob 模式",
    "Extensions": "string[] - 扩展名过滤",
    "Type": "file | directory | any",
    "MaxDepth": "integer - 最大深度",
    "Excludes": "string[] - 排除模式",
    "FullPath": "boolean - 是否匹配完整路径"
  },
  "notes": "结果上限 50 条"
}
```

#### list_dir
```json
{
  "name": "list_dir",
  "description": "列出目录内容",
  "parameters": {
    "DirectoryPath": "string - 绝对路径"
  },
  "output": "相对路径、文件大小/目录项数"
}
```

### 11.2 文件读写类

#### read_file
```json
{
  "name": "read_file",
  "description": "读取文件内容",
  "parameters": {
    "file_path": "string - 绝对路径",
    "offset": "integer - 起始行（1-indexed）",
    "limit": "integer - 读取行数"
  },
  "notes": [
    "输出带行号（cat -n 格式）",
    "支持图片自动显示",
    "超过 2000 字符的行会截断"
  ]
}
```

#### edit
```json
{
  "name": "edit",
  "description": "单次文件编辑（查找替换）",
  "parameters": {
    "file_path": "string - 绝对路径",
    "old_string": "string - 要替换的文本（必须唯一）",
    "new_string": "string - 替换后的文本",
    "replace_all": "boolean - 替换所有匹配",
    "explanation": "string - 修改说明"
  },
  "rules": [
    "编辑前必须先读取文件",
    "old_string 必须在文件中唯一",
    "保持原有缩进"
  ]
}
```

#### multi_edit
```json
{
  "name": "multi_edit",
  "description": "多次文件编辑（批量）",
  "parameters": {
    "file_path": "string",
    "edits": "[{old_string, new_string, replace_all}]",
    "explanation": "string"
  },
  "notes": [
    "编辑按顺序应用",
    "原子操作：全部成功或全部失败",
    "前面的编辑会影响后面的匹配"
  ]
}
```

#### write_to_file
```json
{
  "name": "write_to_file",
  "description": "创建新文件",
  "parameters": {
    "TargetFile": "string - 目标路径",
    "CodeContent": "string - 文件内容",
    "EmptyFile": "boolean - 创建空文件"
  },
  "rules": [
    "只用于创建新文件",
    "不要覆盖已有文件",
    "会自动创建父目录"
  ]
}
```

### 11.3 终端命令类

#### run_command
```json
{
  "name": "run_command",
  "description": "执行终端命令",
  "parameters": {
    "CommandLine": "string - 命令行",
    "Cwd": "string - 工作目录（不要用 cd）",
    "Blocking": "boolean - 阻塞等待完成",
    "WaitMsBeforeAsync": "integer - 非阻塞前等待毫秒",
    "SafeToAutoRun": "boolean - 是否安全自动执行"
  }
}
```

#### command_status
```json
{
  "name": "command_status",
  "description": "检查后台命令状态",
  "parameters": {
    "CommandId": "string - 命令 ID",
    "OutputCharacterCount": "integer - 输出字符数",
    "WaitDurationSeconds": "integer - 等待秒数（最多60）"
  }
}
```

#### read_terminal
```json
{
  "name": "read_terminal",
  "description": "读取终端内容",
  "parameters": {
    "ProcessID": "string - 进程 ID",
    "Name": "string - 终端名称"
  }
}
```

### 11.4 Web 预览与部署类

#### browser_preview
```json
{
  "name": "browser_preview",
  "description": "启动浏览器预览",
  "parameters": {
    "Url": "string - 服务器 URL（含 scheme 和端口）",
    "Name": "string - 3-5 词的标题"
  },
  "notes": "用户需手动点击按钮打开"
}
```

#### deploy_web_app
```json
{
  "name": "deploy_web_app",
  "description": "部署到 Netlify",
  "parameters": {
    "ProjectPath": "string - 项目绝对路径",
    "Framework": "enum - 框架类型",
    "Subdomain": "string - 子域名（新站点）",
    "ProjectId": "string - 项目 ID（重新部署）"
  },
  "supported_frameworks": [
    "eleventy", "angular", "astro", "create-react-app",
    "gatsby", "gridsome", "grunt", "hexo", "hugo",
    "hydrogen", "jekyll", "middleman", "mkdocs", "nextjs",
    "nuxtjs", "remix", "sveltekit", "svelte"
  ]
}
```

#### read_deployment_config
```json
{
  "name": "read_deployment_config",
  "description": "读取部署配置，检查是否可部署",
  "parameters": {
    "ProjectPath": "string"
  }
}
```

#### check_deploy_status
```json
{
  "name": "check_deploy_status",
  "description": "检查部署状态",
  "parameters": {
    "WindsurfDeploymentId": "string - 部署 ID"
  }
}
```

### 11.5 记忆与规划类

#### create_memory
```json
{
  "name": "create_memory",
  "description": "管理持久记忆",
  "parameters": {
    "Action": "create | update | delete",
    "Id": "string - 更新/删除时使用",
    "Title": "string - 记忆标题",
    "Content": "string - 记忆内容",
    "Tags": "string[] - 标签（snake_case）",
    "CorpusNames": "string[] - 关联的工作区",
    "UserTriggered": "boolean - 是否用户主动要求"
  }
}
```

#### update_plan
```json
{
  "name": "update_plan",
  "description": "Updates the task plan. Provide an optional explanation and a list of plan items, each with a step and status. At most one step can be in_progress at a time.",
  "parameters": {
    "type": "object",
    "properties": {
      "explanation": {"type": "string"},
      "plan": {
        "type": "array",
        "items": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "status": {
              "type": "string",
              "enum": ["pending", "in_progress", "completed"]
            },
            "step": {"type": "string"}
          },
          "required": ["step", "status"]
        }
      }
    }
  }
}
```

**使用规则**（来自 System Prompt）：
```
<task_management>
Use update_plan to manage work. 
Limit plans to concise steps which you execute one at a time, 
mark them as done as soon as you complete them, 
and update them when new information arrives. 
Create shared notes only when they add clear value.
</task_management>

Planning cadence: Draft a succinct plan for non-trivial tasks, 
keep only one step in progress, 
and refresh the plan after new constraints or discoveries.
```

### 11.6 网络搜索类

#### search_web
```json
{
  "name": "search_web",
  "description": "网页搜索",
  "parameters": {
    "query": "string - 搜索词",
    "domain": "string - 优先域名（可选）"
  }
}
```

#### read_url_content
```json
{
  "name": "read_url_content",
  "description": "读取网页内容",
  "parameters": {
    "Url": "string - HTTP/HTTPS URL"
  }
}
```

#### view_content_chunk
```json
{
  "name": "view_content_chunk",
  "description": "查看文档分块",
  "parameters": {
    "document_id": "string - 文档 ID（需先 read_url_content）",
    "position": "integer - 分块位置"
  }
}
```

### 11.7 其他工具

#### trajectory_search
```json
{
  "name": "trajectory_search",
  "description": "搜索历史对话",
  "parameters": {
    "ID": "string - 对话 ID",
    "Query": "string - 搜索词（空则返回全部）",
    "SearchType": "cascade | user"
  },
  "notes": "不要对 'user' 类型调用此工具。忽略 @activity 提及。"
}
```

#### read_notebook
```json
{
  "name": "read_notebook",
  "description": "读取 .ipynb 文件",
  "parameters": {
    "AbsolutePath": "string - 绝对路径"
  }
}
```

#### edit_notebook
```json
{
  "name": "edit_notebook",
  "description": "编辑 notebook cell",
  "parameters": {
    "absolute_path": "string",
    "cell_number": "integer - 0-indexed",
    "cell_id": "string - 或用 cell_id",
    "new_source": "string - 新内容",
    "cell_type": "code | markdown",
    "edit_mode": "replace | insert | delete"
  }
}
```

#### list_resources
```json
{
  "name": "list_resources",
  "description": "列出 MCP 服务器资源",
  "parameters": {
    "ServerName": "string"
  },
  "notes": "不是所有 MCP 服务器都有资源"
}
```

#### read_resource
```json
{
  "name": "read_resource",
  "description": "读取 MCP 资源内容",
  "parameters": {
    "ServerName": "string",
    "Uri": "string - 资源标识符"
  }
}
```

---

## 十二、调试与 Bug 修复

### 12.1 调试原则

```
When debugging, only make code changes if you are certain that you can solve the problem.
Otherwise, follow debugging best practices:
1. Address the root cause instead of the symptoms
2. Add descriptive logging statements and error messages to track variable and code state
3. Add test functions and statements to isolate the problem
```

**核心要点**：
- 只有**确定能解决**时才改代码
- 解决**根本原因**，而非症状
- 添加**日志**追踪状态
- 添加**测试**隔离问题

### 12.2 Bug 修复原则

```
Bug fixing discipline:
- Prefer minimal upstream fixes over downstream workarounds
- Identify root cause before implementing
- Avoid over-engineering—use single-line changes when sufficient
- For specialized codebases, verify bug location carefully
- Add regression tests but keep implementation minimal
```

**详细解释**：

| 原则 | 说明 |
|------|------|
| **上游修复优先** | 在问题源头修复，而非在下游打补丁 |
| **先定位根因** | 实现前必须确认问题根源 |
| **避免过度设计** | 能用单行修复就不要大改 |
| **验证位置** | 专业代码库中仔细验证 bug 位置 |
| **回归测试** | 添加测试防止复发，但保持实现最小化 |

### 12.3 调试流程

```
发现问题
    │
    ↓
复现问题（确认症状）
    │
    ↓
添加日志/打印追踪
    │
    ↓
定位根本原因
    │
    ↓
是否确定能解决？
    │
    ├── 否 → 继续调查，添加更多日志
    │
    └── 是 → 实现最小修复
              │
              ↓
         添加回归测试
              │
              ↓
         验证修复有效
```

---

## 十三、长期工作流支持

### 13.1 多会话工作

```
Long-horizon workflow: For multi-session work, consider keeping concise notes 
(e.g., progress.txt) and a list of pending tests when they will genuinely speed up future progress. 
Update them only when they add value.
```

**原则**：
- 多会话工作时保留简洁笔记
- 记录待完成的测试列表
- 只在真正有价值时更新
- 避免过度文档化

### 13.2 进度笔记

```
Progress notes: Prefer lightweight workspace artifacts over long chat recaps, 
but only create new files when they prevent rework and absolutely necessary. 
Avoid creating repeated .md files or excessive documentation for yourself unless asked by the user.
```

**原则**：
- **偏好轻量工件**：而非长聊天回顾
- **避免重复文件**：不要创建多个 .md 文件
- **必要时才创建**：只在能防止返工时
- **用户未要求不创建**：除非用户明确要求

### 13.3 测试纪律

```
Testing discipline: Design or update tests before major implementation work, 
never delete or weaken tests without explicit direction, 
and share targeted verification commands when you cannot run them.
```

**原则**：

| 规则 | 说明 |
|------|------|
| **先设计测试** | 重大实现前先设计/更新测试 |
| **不删除测试** | 未经明确指示不删除或弱化测试 |
| **分享验证命令** | 无法运行时提供可复制的验证命令 |

### 13.4 验证工具

```
Verification tools: Prefer available automated verification (e.g., Playwright, unit tests) 
to confirm work. Provide copy-pastable commands for the user when tools are unavailable.
```

**原则**：
- 优先使用自动化验证（Playwright、单元测试）
- 工具不可用时提供可复制的命令
- 让用户能自己验证

---

## 十四、行为约束汇总

### 14.1 绝对不做的事

```
Cascade 绝对不会：
- 猜测缺失的参数
- 在没有读取的情况下编辑文件
- 自动运行可能有破坏性的命令
- 创建不必要的文件污染工作区
- 删除或弱化测试（未经指示）
- 以 "Great idea!" 等短语开头
```

### 14.2 主动会做的事

```
Cascade 会主动：
- 推断用户意图并执行（而非只建议）
- 使用工具获取缺失信息（而非询问用户）
- 批量执行独立操作提高效率
- 在完成时提供清晰的状态总结
- 添加所有必要的 import 和依赖
- 创建依赖管理文件和 README（新项目）
```

### 14.3 需要用户配合的事

```
需要用户确认：
- 执行不安全命令（rm、install 等）
- 用户可以通过允许列表自定义

需要用户提供：
- API Key（会提醒，不硬编码）
- 特定参数值（不猜测）
```

---

## 附录：关键设计决策总结

| 设计点 | Windsurf 的选择 | 原因 |
|--------|----------------|------|
| 工具传递方式 | Function Call | 结构化、模型原生支持 |
| 搜索策略 | Fast Context 子代理 | 封装复杂搜索逻辑 |
| 并行调用 | 独立操作并行 | 提高效率 |
| 安全机制 | SafeToAutoRun 参数 | 平衡效率和安全 |
| 记忆系统 | 三层记忆 | 灵活性和持久性 |
| 用户扩展 | 不支持 Skills | 简化实现，聚焦核心场景 |

---

## 参考资料

- Anthropic Claude Skills: https://www.anthropic.com/news/skills
- Anthropic Programmatic Tool Calling: https://www.anthropic.com/engineering/advanced-tool-use
- Model Context Protocol (MCP): https://modelcontextprotocol.io/

---

*文档生成时间：2025年12月17日*
*最后更新：2025年12月17日（补充思考模式、子代理架构、Non-trivial判断标准）*
*基于 Cascade 系统配置整理*
