# Typesetting Engine Progress Log

Plan: docs/TYPESETTING_ENGINE_PLAN.md

## Entries
- 2026-01-20: Initialized progress log.
- 2026-01-20
  - Task completed: Environment update -> Use local Windows Rust toolchain for tests (no WSL)
  - Key decisions: Run Rust tests locally with `C:\Users\10758\.cargo\bin\cargo.exe`; note that cargo is not on PATH.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Optional PATH update to simplify commands.
- 2026-01-20
  - Task completed: M0 -> Clarify PDF output and print flow (preview -> PDF -> print)
  - Key decisions: Preview uses the same PDF render pipeline; print only from exported PDF; default to no scaling.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define WYSIWYG acceptance thresholds; finalize default tech stack decision.
- 2026-01-20
  - Task completed: M0 -> Lock the tech stack and mark the final decision in "Default tech stack"
  - Key decisions: Locked the default tech stack (M0); record any changes in the same section.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define WYSIWYG acceptance thresholds. Tests not run (docs-only).
- 2026-01-20
  - Task completed: M0 -> Write WYSIWYG acceptance thresholds (pixel/mm)
  - Key decisions: Added explicit page size, margin/header/footer, line spacing, and page-break deltas; used 96dpi as the px reference.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-20
  - Task completed: M1 -> Define document node types (Paragraph/Heading/List/Table/Image)
  - Key decisions: Drafted core block/inline node list with optional ids and style refs placeholders.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define style structs and ops; tests not run (docs-only).

- 2026-01-20
  - Task completed: M1 -> Define style structs (FontStyle/ParagraphStyle/PageStyle)
  - Key decisions: Drafted minimal JSON-friendly fields with explicit units for lengths; added ids for style refs.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define minimal ops; draft JSON schema; tests not run (docs-only).

- 2026-01-20
  - Task completed: M1 -> Design minimal ops (insert/delete/applyStyle)
  - Key decisions: Added Position/Range-based ops; split applyStyle into inline marks vs paragraph style refs; use UTF-16 offsets for editor compatibility.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Draft the JSON schema for serialization; tests not run (docs-only).
- 2026-01-20
  - Task completed: M1 -> Define serialization format (JSON schema draft)
  - Key decisions: Added JSON Schema with type discriminators for block/inline unions; included optional styles collections for font/paragraph/page.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Align in-memory model vs serialization type tags; tests not run (docs-only).

- 2026-01-20
  - Task completed: M2 -> Font discovery (list system fonts + fallback rules)
  - Key decisions: Enumerate fonts via OS APIs; resolve missing glyphs per-glyph; fallback order user -> doc -> system -> open-source.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Implement font loading and default zh/en mapping; tests not run (docs-only).
- 2026-01-20
  - Task completed: M2 -> Font loading: load from path and cache metrics
  - Key decisions: Parse units_per_em/ascender/descender/line_gap via ttf-parser; cache by path with shared font bytes; use KaTeX font fixture for tests.
  - Files changed: src-tauri/src/typesetting/font_manager.rs; src-tauri/src/typesetting/mod.rs; src-tauri/src/lib.rs; src-tauri/Cargo.toml; src-tauri/tests/fixtures/katex-main-regular.ttf
  - Blockers/next steps: WSL distro not found; run WSL test/lint/CI once available.
- 2026-01-20
  - Task completed: M2 -> Font mapping table (zh/en default mapping)
  - Key decisions: Default mapping uses SimSun (zh) + Times New Roman (en); resolve trims whitespace and falls back to the other mapping or defaults when missing.
  - Files changed: src-tauri/src/typesetting/font_manager.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro not found; run WSL cargo test/full lint/CI when available.
- 2026-01-20
  - Task completed: M2 -> Font loading (load from path and cache metrics) [plan checkbox sync]
  - Key decisions: Marked the M2 font loading task as complete in the plan to match the implemented FontManager::load_from_path.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-20
  - Task completed: M3 -> Integrate shaping, get glyph runs
  - Key decisions: Added a rustybuzz-based shaping API with ScriptKind mapping (Han/Latin) and raw glyph positions in font units.
  - Files changed: src-tauri/Cargo.toml; src-tauri/src/typesetting/mod.rs; src-tauri/src/typesetting/shaping.rs
  - Blockers/next steps: WSL Ubuntu distro not found; unable to run cargo test/clippy/fmt. Run WSL tests/lint once available, then continue M3 line breaking.
- 2026-01-20
  - Task completed: M3 -> Implement line breaking (width-based)
  - Key decisions: Implemented greedy width-based line breaking with optional soft-break hints; edge cases covered: empty input, oversized glyphs, no soft break before overflow, exact-fit soft breaks.
  - Files changed: src-tauri/src/typesetting/line_break.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found; unable to run cargo fmt/clippy/test in WSL.
- 2026-01-20
  - Task completed: M3 -> Implement mixed-script merge (CJK + Latin)
  - Key decisions: Split text into script runs using CJK ranges; merge glyph runs by offsetting clusters with UTF-8 byte indices; reuse the same font for both scripts for now.
  - Files changed: src-tauri/src/typesetting/shaping.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found; unable to run cargo fmt/clippy/test in WSL.

- 2026-01-20
  - Task completed: M4 -> First-line indent and space before/after
  - Key decisions: Added first-line indent and paragraph spacing parameters; y_offset includes space_before; space_after recorded on last line; justification uses available width after indent.
  - Files changed: src-tauri/src/typesetting/paragraph_layout.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found; run cargo fmt/clippy/test in WSL once available. Continue M4 align/line-height task if needed.
- 2026-01-19
  - Task completed: M4 -> Paragraph line height and alignment (left/right/center/justify) [plan checkbox sync]
  - Key decisions: Marked the M4 align/line-height task as complete to reflect existing paragraph layout implementation (alignment offsets + line height spacing).
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-19
  - Task completed: M5 -> Page model (paper size, margins, content box)
  - Key decisions: Added PageSize (A4/Letter/Custom) and PageStyle with margins + header/footer heights; exposed page/body/header/footer boxes in mm with non-negative clamping.
  - Files changed: src-tauri/src/typesetting/page_model.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: `cargo test` timed out while updating rsproxy index; rerun tests when network/index available. Continue M5 header/footer layout or simple pagination next.
- 2026-01-19
  - Task completed: M5 -> Simple pagination (flow-based page breaks)
  - Key decisions: Added paginate_flow with PageSlice boundaries; break only when positive height overflows; clamp negative heights to zero.
  - Files changed: src-tauri/src/typesetting/pagination.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro not found (wsl -l -q empty); unable to run cargo fmt/clippy/test in WSL. Next: header/footer layout or minimal widow/orphan control.
- 2026-01-19
  - Task completed: M5 -> Header/footer layout
  - Key decisions: Added header/footer content boxes with top-aligned header and bottom-aligned footer; clamp content heights to header/footer boxes and treat negative heights as zero.
  - Files changed: src-tauri/src/typesetting/page_model.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (Wsl/Service/WSL_E_DISTRO_NOT_FOUND); unable to run cargo fmt/clippy/test in WSL. Next: implement basic widow/orphan control.
- 2026-01-19
  - Task completed: M5 -> Basic widow/orphan handling (minimal)
  - Key decisions: Added widow/orphan-aware pagination for line-based layouts; when a break would create a widow/orphan, move the break to the paragraph start if both pages still fit; use paragraph-end markers to detect splits.
  - Files changed: src-tauri/src/typesetting/pagination.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (Wsl/Service/WSL_E_DISTRO_NOT_FOUND); unable to run `cargo test` in WSL. Next: wire widow/orphan-aware pagination into the layout pipeline and run WSL tests/lint once a distro is available.
- 2026-01-19
  - Task completed: M6 -> Render pipeline: preview pages scaffolding (layout lines -> preview pages)
  - Key decisions: Added PreviewPage/PreviewLine structs and build_preview_pages; line heights include space_before on first line and space_after on last line for pagination.
  - Files changed: src-tauri/src/typesetting/preview_pipeline.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (Wsl/Service/WSL_E_DISTRO_NOT_FOUND); unable to run cargo fmt/clippy/test in WSL. Next: connect preview pages to page boxes and add basic zoom/pagination browsing.

- 2026-01-19
  - Task completed: M6 -> Basic zoom and paginated browsing
  - Key decisions: Added PreviewViewport helpers for zoomed page sizing, page spans, and visible page ranges; clamp zoom to >= 0.1 and gaps to >= 0 to keep math stable.
  - Files changed: src-tauri/src/typesetting/preview_viewport.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (wsl -l -q empty); unable to run cargo fmt/clippy/test in WSL.

- 2026-01-19
  - Task completed: M6 -> Render pipeline: layout tree -> preview pages
  - Key decisions: Added preview metrics converting PageStyle mm to px with a default 96dpi fallback; new helper builds preview pages using body box height for pagination.
  - Files changed: src-tauri/src/typesetting/preview_pipeline.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro not found (wsl -l -q empty); unable to run WSL cargo fmt/clippy/test/ci.
- 2026-01-19
  - Task completed: M7 -> PDF document generation (minimal blank PDF scaffolding)
  - Key decisions: Hand-wrote a minimal PDF structure (Catalog/Pages/Page/Contents + xref); page size converts mm -> pt; invalid sizes error out.
  - Files changed: src-tauri/src/typesetting/pdf_export.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run WSL cargo test/ci. Next: add font embedding and content stream output.
- 2026-01-19
  - Task completed: M7 -> Font embedding and font subset (embed TrueType stream + subset tag)
  - Key decisions: Embed fonts via /FontFile2 + ASCIIHexDecode; subset name uses deterministic 6-letter prefix + sanitized font name; FontDescriptor reuses ttf-parser bounds and ascent/descent metrics.
  - Files changed: src-tauri/src/typesetting/pdf_export.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run cargo fmt/clippy/test. Next: real glyph subsetting (Widths/Encoding/ToUnicode) and PDF/preview alignment verification.

- 2026-01-19
  - Task completed: M7 -> PDF/preview alignment verification
  - Key decisions: Added pdf_page_size_points helper; added alignment test converting PDF points to preview pixels at 96dpi to confirm MediaBox size matches preview metrics.
  - Files changed: src-tauri/src/typesetting/pdf_export.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run cargo fmt/clippy/test in WSL.
- 2026-01-19
  - Task completed: M7 -> PDF document generation [plan checkbox sync]
  - Key decisions: Marked the plan checkbox as complete to reflect the existing minimal PDF document generation scaffold.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-19
  - Task completed: M9 -> Define AI schema validation (zod)
  - Key decisions: Added strict zod schema for page/typography/paragraph fields with unit-validated lengths; font sizes restricted to pt.
  - Files changed: src/typesetting/aiSchema.ts; src/typesetting/aiSchema.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run npm run test:run or lint/CI in WSL. Next: parse natural language -> schema (minimal rules) and apply schema to document styles.
- 2026-01-19
  - Task completed: M9 -> Apply schema -> document styles
  - Key decisions: Added a style-mapping helper that merges AI instructions into a base style config and preserves footerHeight when omitted; return new objects to avoid mutation.
  - Files changed: src/typesetting/aiStyleMapper.ts; src/typesetting/aiStyleMapper.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro not found (no `wsl -l` entries), so tests/lint/CI not run. Next: mark/verify M9 prompt parsing if needed and wire style application into editor state.
- 2026-01-19
  - Task completed: M7 -> PDF/preview alignment verification [plan checkbox sync]
  - Key decisions: Marked the plan checkbox complete to reflect the existing PDF/preview alignment verification test.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-19
  - Task completed: M9 -> Parse natural language -> schema (minimal rules) [plan checkbox sync]
  - Key decisions: Marked the plan checkbox as complete to reflect the existing aiPromptParser implementation.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-19
  - Task completed: M7 -> Sync plan checkboxes for PDF document generation and font embedding
  - Key decisions: Marked M7 PDF doc generation and font embedding as complete to match existing implementation.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-19
  - Task completed: M8 -> Print settings guide (disable scaling, paper match)
  - Key decisions: Added a concise print dialog checklist covering no-scaling, paper size match, and disabling auto-geometry adjustments.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Add margin calibration flow (record device offsets). Tests not run (docs-only).
- 2026-01-19
  - Task completed: M8 -> Margin calibration flow (record device offsets)
  - Key decisions: Drafted a calibration PDF workflow with crosshair measurements; store per-printer dx/dy offsets and apply as origin compensation only.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only). Next: M10 docx import tasks.
- 2026-01-19
  - Task completed: M9 -> Define AI schema validation (zod) [plan checkbox sync]
  - Key decisions: Marked the plan checkbox complete to reflect the existing zod schema implementation.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-19
  - Task completed: M10 -> Parse paragraphs/headings/font styles
  - Key decisions: Implemented a minimal WordprocessingML parser with DOMParser; detect HeadingN styles; convert w:sz half-points to pt; omit disabled run styles; added empty-body edge case test.
  - Files changed: src/typesetting/docxImport.ts; src/typesetting/docxImport.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run `npm run test:run` in WSL. Next: parse lists/tables/images.
- 2026-01-19
  - Task completed: M10 -> Parse lists, simple tables, images
  - Key decisions: Group list items by numId/ilvl into list blocks (ordered default false); parse tables into row/cell paragraph blocks; extract image embedIds from drawing blips and emit image blocks when paragraphs are image-only.
  - Files changed: src/typesetting/docxImport.ts; src/typesetting/docxImport.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); `wsl -d Ubuntu` failed, so `npm run test:run`/lint/CI not run. Next: M10 import headers/footers.
- 2026-01-19
  - Task completed: M10 -> Import headers/footers (docx header/footer XML parsing)
  - Key decisions: Added parseDocxHeaderFooterXml that accepts w:hdr/w:ftr roots (or their unprefixed variants) and reuses body parsing for blocks.
  - Files changed: src/typesetting/docxImport.ts; src/typesetting/docxImport.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro list empty; unable to run WSL tests/lint. Next: run npm test/lint in WSL once a distro is available and wire header/footer parts into the docx package importer.
- 2026-01-19
  - Task completed: M11 -> Export paragraphs/headings/font styles
  - Key decisions: Added a minimal WordprocessingML exporter for paragraph/heading blocks with run-level font, size (half-points), and bold/italic/underline styles; emit tabs/line breaks for \t/\n and escape XML text.
  - Files changed: src/typesetting/docxExport.ts; src/typesetting/docxExport.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run npm tests in WSL. Next: export lists/simple tables/images and wire header/footer/page number export.
- 2026-01-19
  - Task completed: M11 -> Export lists, simple tables, images
  - Key decisions: Added list/table/image serialization in document.xml; list items use numId 1 (ordered) or 2 (unordered) with ilvl 0; images emit w:drawing with a:blip r:embed; table cells fall back to an empty paragraph when needed.
  - Files changed: src/typesetting/docxExport.ts; src/typesetting/docxExport.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run wsl -d Ubuntu -- npm run test:run -- docxExport.test.ts. Next: export headers/footers and page numbers.

- 2026-01-19
  - Task completed: M11 -> Export headers/footers and page numbers
  - Key decisions: Added header/footer XML builders and a PAGE field helper; ensure empty headers/footers emit a fallback paragraph.
  - Files changed: src/typesetting/docxExport.ts; src/typesetting/docxExport.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run WSL npm tests/lint/CI.

- 2026-01-19
  - Task completed: M12 -> Add golden fixtures (short/long/bilingual docs) [initial fixture set]
  - Key decisions: Store fixtures in src-tauri/tests/fixtures/typesetting using the M1 JSON schema draft; include a bilingual sample with CJK text.
  - Files changed: src-tauri/tests/fixtures/typesetting/short.json; src-tauri/tests/fixtures/typesetting/long.json; src-tauri/tests/fixtures/typesetting/bilingual.json; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Wire fixtures into golden/layout diff tests and update the plan checkbox after validation. Tests not run (fixtures-only).
- 2026-01-19
  - Task completed: M12 -> Golden fixtures: short/long/bilingual docs [plan checkbox sync]
  - Key decisions: Marked the plan checkbox complete to reflect existing fixture files in src-tauri/tests/fixtures/typesetting.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).

- 2026-01-19
  - Task completed: M13 -> Integrate engine preview into app UI (paged view + zoom controls) [scaffold typesetting preview tab]
  - Key decisions: Added a typesetting-preview tab type with a command palette entry; scaffolded a placeholder pane for later engine output wiring.
  - Files changed: src/stores/useFileStore.ts; src/components/search/CommandPalette.tsx; src/components/layout/TabBar.tsx; src/components/typesetting/TypesettingPreviewPane.tsx; src/App.tsx; src/__tests__/useFileStore.typesettingPreview.test.ts; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run npm run test:run in WSL. Next: wire the preview pane to the Rust layout/PDF pipeline and add zoom/page controls.
- 2026-01-19
  - Task completed: M13 -> Preview pane now consumes Rust typesetting page metrics (A4 + margins)
  - Key decisions: Added a Tauri command returning page/body/header/footer boxes in mm (A4, 25mm margins, 12mm header/footer); UI converts mm -> px at 96dpi and renders the page box overlays.
  - Files changed: src-tauri/src/commands/mod.rs; src-tauri/src/main.rs; src/components/typesetting/TypesettingPreviewPane.tsx; src/components/typesetting/TypesettingPreviewPane.test.tsx; src/__tests__/setup.ts
  - Blockers/next steps: `C:\Users\10758\.cargo\bin\cargo.exe test typesetting_preview_page_mm` failed (rustybuzz Script::Han/Latin + Language::from_str signature errors in src-tauri/src/typesetting/shaping.rs). Frontend test ran: `npm run test:run -- TypesettingPreviewPane`.
- 2026-01-19
  - Task completed: M13 -> Integrate engine preview into app UI (paged view + zoom controls) [zoom controls]
  - Key decisions: Zoom controls clamp between 50% and 200% in 10% steps; scale preview boxes by zoom while keeping base mm->px conversion at 96dpi.
  - Files changed: src/components/typesetting/TypesettingPreviewPane.tsx; src/components/typesetting/TypesettingPreviewPane.test.tsx; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run WSL npm tests/lint/CI. Next: wire preview pane to real layout/PDF pipeline.
- 2026-01-19
  - Task completed: M13 -> Add a minimal "apply intent" entrypoint for AI-driven layout changes
  - Key decisions: Added applyAiPromptToStyles wrapper to parse prompts into the AI schema and merge into base styles; returns both instruction and merged styles for downstream wiring.
  - Files changed: src/typesetting/aiIntent.ts; src/typesetting/aiIntent.test.ts; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro list empty (`wsl -l -q`); unable to run WSL npm test/lint/CI. Next: wire this entrypoint into the UI/agent pipeline.

- 2026-01-19
  - Task completed: M13 -> Unblock typesetting preview Rust build (rustybuzz API update in shaping)
  - Key decisions: Use rustybuzz::script::HAN/LATIN; handle Language::from_str Result with Ok guard.
  - Files changed: src-tauri/src/typesetting/shaping.rs; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: `C:\Users\10758\.cargo\bin\cargo.exe test -p lumina-note typesetting_preview_page_mm` failed due to unresolved `lumina_lib` in tests/mcp_integration.rs and missing `crate::typesetting` import in src-tauri/src/commands/mod.rs; address those to restore Rust tests.
- 2026-01-19
  - Task completed: M13 -> Connect export/print UI to PDF output (placeholder typesetting export button + Tauri command)
  - Key decisions: Added `typesetting_export_pdf_base64` using the existing empty-PDF generator and shared the default A4/margins style between preview + export; preview pane now saves the base64 PDF via Tauri FS APIs.
  - Files changed: src-tauri/src/commands/mod.rs; src-tauri/src/main.rs; src/components/typesetting/TypesettingPreviewPane.tsx; src/components/typesetting/TypesettingPreviewPane.test.tsx; src/__tests__/setup.ts
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND), so npm/cargo tests/lint not run in WSL. Next: render real layout content into PDF and embed fonts before replacing the legacy html2canvas export.
- 2026-01-19
  - Task completed: M13 -> Wire document model edits to layout pipeline (incremental reflow) [add text-to-layout adapter]
  - Key decisions: Added a text_layout helper that shapes mixed text, derives whitespace break opportunities from glyph clusters, and feeds line breaking + paragraph layout.
  - Files changed: src-tauri/src/typesetting/text_layout.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro list empty (`wsl -l -q`), so WSL tests/lint/CI not run. Next: wire this helper into a Tauri command or document model adapter.
- 2026-01-19
  - Task completed: M13 -> Wire document model edits to layout pipeline (incremental reflow) [layout_text Tauri command]
  - Key decisions: Exposed a placeholder Tauri command that runs paragraph layout for plain text with left alignment and returns line metrics; input includes a font file path to keep loading explicit.
  - Files changed: src-tauri/src/commands/mod.rs; src-tauri/src/main.rs; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (WSL_E_DISTRO_NOT_FOUND); unable to run cargo fmt/clippy/test in WSL. Next: wire UI to call this command and pass real font paths from the font manager.
