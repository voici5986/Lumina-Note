# Typesetting Engine Progress Log

Plan: docs/TYPESETTING_ENGINE_PLAN.md

## Entries
- 2026-01-20: Initialized progress log.
- 2026-01-20
  - Task completed: M0 -> 明确 PDF 输出与打印流程（预览 -> PDF -> 打印）
  - Key decisions: Preview uses the same PDF render pipeline; print only from exported PDF; default to no scaling.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define WYSIWYG acceptance thresholds; finalize default tech stack decision.
- 2026-01-20
  - Task completed: M0 -> 固化技术栈选择并在“默认技术栈”中标记最终决定
  - Key decisions: Locked the default tech stack (M0); record any changes in the same section.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define WYSIWYG acceptance thresholds. Tests not run (docs-only).
- 2026-01-20
  - Task completed: M0 -> Write WYSIWYG acceptance thresholds (pixel/mm)
  - Key decisions: Added explicit page size, margin/header/footer, line spacing, and page-break deltas; used 96dpi as the px reference.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-20
  - Task completed: M1 -> Define document node types (Paragraph/Heading/List/Table/Image)
  - Key decisions: Drafted core block/inline node list with optional ids and style refs placeholders.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define style structs and ops; tests not run (docs-only).

- 2026-01-20
  - Task completed: M1 -> Define style structs (FontStyle/ParagraphStyle/PageStyle)
  - Key decisions: Drafted minimal JSON-friendly fields with explicit units for lengths; added ids for style refs.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Define minimal ops; draft JSON schema; tests not run (docs-only).

- 2026-01-20
  - Task completed: M1 -> Design minimal ops (insert/delete/applyStyle)
  - Key decisions: Added Position/Range-based ops; split applyStyle into inline marks vs paragraph style refs; use UTF-16 offsets for editor compatibility.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Draft the JSON schema for serialization; tests not run (docs-only).
- 2026-01-20
  - Task completed: M1 -> 确定序列化格式（JSON schema 草案）
  - Key decisions: Added JSON Schema with type discriminators for block/inline unions; included optional styles collections for font/paragraph/page.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Align in-memory model vs serialization type tags; tests not run (docs-only).

- 2026-01-20
  - Task completed: M2 -> Font discovery (list system fonts + fallback rules)
  - Key decisions: Enumerate fonts via OS APIs; resolve missing glyphs per-glyph; fallback order user -> doc -> system -> open-source.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Implement font loading and default zh/en mapping; tests not run (docs-only).
- 2026-01-20
  - Task completed: M2 -> 字体加载：从路径加载并缓存度量
  - Key decisions: Parse units_per_em/ascender/descender/line_gap via ttf-parser; cache by path with shared font bytes; use KaTeX font fixture for tests.
  - Files changed: src-tauri/src/typesetting/font_manager.rs; src-tauri/src/typesetting/mod.rs; src-tauri/src/lib.rs; src-tauri/Cargo.toml; src-tauri/tests/fixtures/katex-main-regular.ttf
  - Blockers/next steps: WSL distro not found; run WSL test/lint/CI once available.
- 2026-01-20
  - Task completed: M2 -> Font mapping table (zh/en default mapping)
  - Key decisions: Default mapping uses SimSun (zh) + Times New Roman (en); resolve trims whitespace and falls back to the other mapping or defaults when missing.
  - Files changed: src-tauri/src/typesetting/font_manager.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro not found; run WSL cargo test/full lint/CI when available.
- 2026-01-20
  - Task completed: M2 -> Font loading (load from path and cache metrics) [plan checkbox sync]
  - Key decisions: Marked the M2 font loading task as complete in the plan to match the implemented FontManager::load_from_path.
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-20
  - Task completed: M3 -> 集成 shaping，得到 glyph runs
  - Key decisions: Added a rustybuzz-based shaping API with ScriptKind mapping (Han/Latin) and raw glyph positions in font units.
  - Files changed: src-tauri/Cargo.toml; src-tauri/src/typesetting/mod.rs; src-tauri/src/typesetting/shaping.rs
  - Blockers/next steps: WSL Ubuntu distro not found; unable to run cargo test/clippy/fmt. Run WSL tests/lint once available, then continue M3 line breaking.
- 2026-01-20
  - Task completed: M3 -> 实现断行（按宽度折行）
  - Key decisions: Implemented greedy width-based line breaking with optional soft-break hints; edge cases covered: empty input, oversized glyphs, no soft break before overflow, exact-fit soft breaks.
  - Files changed: src-tauri/src/typesetting/line_break.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found; unable to run cargo fmt/clippy/test in WSL.
- 2026-01-20
  - Task completed: M3 -> Implement mixed-script merge (CJK + Latin)
  - Key decisions: Split text into script runs using CJK ranges; merge glyph runs by offsetting clusters with UTF-8 byte indices; reuse the same font for both scripts for now.
  - Files changed: src-tauri/src/typesetting/shaping.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found; unable to run cargo fmt/clippy/test in WSL.

- 2026-01-20
  - Task completed: M4 -> 首行缩进与段前段后
  - Key decisions: Added first-line indent and paragraph spacing parameters; y_offset includes space_before; space_after recorded on last line; justification uses available width after indent.
  - Files changed: src-tauri/src/typesetting/paragraph_layout.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found; run cargo fmt/clippy/test in WSL once available. Continue M4 align/line-height task if needed.
- 2026-01-19
  - Task completed: M4 -> 段落行距与对齐（左/右/居中/两端） [plan checkbox sync]
  - Key decisions: Marked the M4 align/line-height task as complete to reflect existing paragraph layout implementation (alignment offsets + line height spacing).
  - Files changed: docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: Tests not run (docs-only).
- 2026-01-19
  - Task completed: M5 -> Page model（纸张尺寸、边距、可用区）
  - Key decisions: Added PageSize (A4/Letter/Custom) and PageStyle with margins + header/footer heights; exposed page/body/header/footer boxes in mm with non-negative clamping.
  - Files changed: src-tauri/src/typesetting/page_model.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: `cargo test` timed out while updating rsproxy index; rerun tests when network/index available. Continue M5 header/footer layout or simple pagination next.
- 2026-01-19
  - Task completed: M5 -> 简单分页（按块流式切页）
  - Key decisions: Added paginate_flow with PageSlice boundaries; break only when positive height overflows; clamp negative heights to zero.
  - Files changed: src-tauri/src/typesetting/pagination.rs; src-tauri/src/typesetting/mod.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL distro not found (wsl -l -q empty); unable to run cargo fmt/clippy/test in WSL. Next: header/footer layout or minimal widow/orphan control.
- 2026-01-19
  - Task completed: M5 -> 页眉页脚布局
  - Key decisions: Added header/footer content boxes with top-aligned header and bottom-aligned footer; clamp content heights to header/footer boxes and treat negative heights as zero.
  - Files changed: src-tauri/src/typesetting/page_model.rs; docs/TYPESETTING_ENGINE_PLAN.md; docs/TYPESETTING_ENGINE_PROGRESS.md
  - Blockers/next steps: WSL Ubuntu distro not found (Wsl/Service/WSL_E_DISTRO_NOT_FOUND); unable to run cargo fmt/clippy/test in WSL. Next: implement basic widow/orphan control.
